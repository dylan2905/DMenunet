<?php include_once "verificar_sesion.php"; ?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Menú - DMENUNET</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-color: #dee2e6 #dee2e6 #fff;
            border-bottom: 3px solid #0d6efd;
        }
        .nav-tabs .nav-link {
            color: #6c757d;
        }
        .list-group-item.category {
            font-weight: bold;
            background-color: #e9ecef;
        }
        .list-group-item.group {
            background-color: #f8f9fa;
        }
        .list-group-item.subgroup {
            background-color: #fff;
        }
        .list-group-item.product {
            border-left: 3px solid #0d6efd;
            margin-left: 20px;
        }
        .list-group-item.product .product-price {
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/index_prueba.html"><i class="bi bi-house me-2"></i>DMENUNET</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="inventario.html"><i class="bi bi-boxes"></i> Inventario</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="crear_producto.html"><i class="bi bi-plus-circle"></i> Crear Producto</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="mesas.html"><i class="bi bi-shop"></i> Mesas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="pedidos.html"><i class="bi bi-receipt"></i> Pedidos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="historial_ventas.html"><i class="bi bi-clock-history"></i> Historial de Ventas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ajustes.html"><i class="bi bi-gear"></i> Ajustes</a>
                </li>
            </ul>
            <a href="logout.php" class="btn btn-outline-light">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
            </a>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h1 class="mb-4 text-center">Gestor de Menú</h1>
    
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="gestionar-grupos-tab" data-bs-toggle="tab" data-bs-target="#gestionar-grupos" type="button" role="tab" aria-controls="gestionar-grupos" aria-selected="true"><i class="bi bi-folder-plus me-1"></i>Gestionar Categorías y Grupos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="crear-producto-tab" data-bs-toggle="tab" data-bs-target="#crear-producto" type="button" role="tab" aria-controls="crear-producto" aria-selected="false"><i class="bi bi-box me-1"></i>Gestionar Productos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="gestionar-menu-tab" data-bs-toggle="tab" data-bs-target="#gestionar-menu" type="button" role="tab" aria-controls="gestionar-menu" aria-selected="false"><i class="bi bi-list-nested me-1"></i>Ver Menú</button>
        </li>
    </ul>

    <div class="tab-content pt-4" id="mainTabContent">
        <div class="tab-pane fade show active" id="gestionar-grupos" role="tabpanel" aria-labelledby="gestionar-grupos-tab">
            <div class="card p-4 shadow-sm">
                <h2 class="mb-4 text-center">Gestionar Categorías y Grupos</h2>
                <div class="accordion" id="accordionGroups">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                <i class="bi bi-folder me-2"></i>Paso 1: Crear Categoría
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionGroups">
                            <div class="accordion-body">
                                <form id="categoryForm">
                                    <div class="mb-3">
                                        <label for="categoryName" class="form-label">Nombre de la Categoría</label>
                                        <input type="text" class="form-control" id="categoryName" placeholder="Ej: Bebidas, Comida, Snacks" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-folder-plus me-1"></i>Añadir Categoría
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                <i class="bi bi-folder-fill me-2"></i>Paso 2: Crear Grupo
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionGroups">
                            <div class="accordion-body">
                                <form id="groupForm">
                                    <div class="mb-3">
                                        <label for="groupCategory" class="form-label">Categoría Principal</label>
                                        <select class="form-select" id="groupCategory" required>
                                            <option value="">Selecciona una categoría</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="groupName" class="form-label">Nombre del Grupo</label>
                                        <input type="text" class="form-control" id="groupName" placeholder="Ej: Gaseosas, Jugos, Café" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-folder-plus me-1"></i>Añadir Grupo
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                <i class="bi bi-collection-fill me-2"></i>Paso 3: Crear Subgrupo
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionGroups">
                            <div class="accordion-body">
                                <form id="subgroupForm">
                                    <div class="mb-3">
                                        <label for="subgroupGroup" class="form-label">Grupo Principal</label>
                                        <select class="form-select" id="subgroupGroup" required>
                                            <option value="">Selecciona un grupo</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="subgroupName" class="form-label">Nombre del Subgrupo</label>
                                        <input type="text" class="form-control" id="subgroupName" placeholder="Ej: Refrescos, Jugos naturales, Café negro" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-collection-plus me-1"></i>Añadir Subgrupo
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">

                <h2 class="mb-3">Estructura Existente</h2>
                <div id="structureDisplay" class="list-group">
                    <div class="list-group-item text-muted text-center">Cargando estructura...</div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="crear-producto" role="tabpanel" aria-labelledby="crear-producto-tab">
            <div class="card p-4 shadow-sm">
                <h2 class="mb-4 text-center">Registrar Nuevo Producto</h2>
                <form id="formCrearProducto">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre" class="form-label">Nombre del Producto</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="col-md-6">
                            <label for="precio" class="form-label">Precio ($)</label>
                            <input type="number" step="0.01" class="form-control" id="precio" required>
                        </div>
                        <div class="col-md-6">
                            <label for="stock" class="form-label">Stock Inicial</label>
                            <input type="number" class="form-control" id="stock" required>
                        </div>
                        <div class="col-md-6">
                            <label for="categoria" class="form-label">Categoría</label>
                            <select class="form-select" id="categoria" required>
                                <option value="">Cargando categorías...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="grupo" class="form-label">Grupo</label>
                            <select class="form-select" id="grupo" disabled>
                                <option value="">Seleccione un grupo (opcional)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="subgrupo" class="form-label">Subgrupo</label>
                            <select class="form-select" id="subgrupo" disabled>
                                <option value="">Seleccione un subgrupo (opcional)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="sub_subgrupo" class="form-label">Sub-Subgrupo</label>
                            <select class="form-select" id="sub_subgrupo" disabled>
                                <option value="">Seleccione un sub-subgrupo (opcional)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="codigoProducto" class="form-label">Código Automático</label>
                            <input type="text" class="form-control" id="codigoProducto" readonly>
                        </div>
                        <div class="col-12">
                            <label for="detalle" class="form-label">Detalles (opcional)</label>
                            <input type="text" class="form-control" id="detalle">
                        </div>
                    </div>
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle-fill me-2"></i>Crear Producto
                        </button>
                    </div>
                </form>
                <div id="resultado-mensaje" class="mt-3 text-center"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="gestionar-menu" role="tabpanel" aria-labelledby="gestionar-menu-tab">
            <div class="card p-4 shadow-sm">
                <h2 class="mb-4 text-center">Vista General del Menú</h2>
                <div id="menuDisplay" class="list-group">
                    <div class="list-group-item text-muted text-center">Cargando menú...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Variables para los selectores principales
    const categoriaSelect = document.getElementById('categoria');
    const grupoSelect = document.getElementById('grupo');
    const subgrupoSelect = document.getElementById('subgrupo');
    const sub_subgrupoSelect = document.getElementById('sub_subgrupo');
    const codigoInput = document.getElementById('codigoProducto');
    
    // Variables para los formularios de gestión
    const categoryForm = document.getElementById('categoryForm');
    const groupForm = document.getElementById('groupForm');
    const subgroupForm = document.getElementById('subgroupForm');
    const groupCategorySelect = document.getElementById('groupCategory');
    const subgroupGroupSelect = document.getElementById('subgroupGroup');

    // --- Funciones de Lógica de Negocio (Interactuar con tu Backend) ---
    
    // Función para cargar opciones en un select
    function cargarOpciones(selectElement, data, placeholder) {
        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        if (data.length > 0) {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.nombre;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        } else {
            selectElement.disabled = true;
        }
    }

    // Cargar categorías al inicio para todos los selectores
    async function cargarCategoriasGrupos() {
        try {
            const response = await fetch('./api/obtener_categorias.php');
            const data = await response.json();
            
            // Para el formulario de producto
            cargarOpciones(categoriaSelect, data, 'Seleccione una categoría');
            
            // Para el formulario de grupos
            cargarOpciones(groupCategorySelect, data, 'Seleccione una categoría');
        } catch (error) {
            console.error('Error al cargar categorías:', error);
            categoriaSelect.innerHTML = '<option value="">Error al cargar</option>';
            groupCategorySelect.innerHTML = '<option value="">Error al cargar</option>';
        }
    }

    // Cargar grupos para el formulario de subgrupos
    async function cargarGruposParaSubgrupos() {
        try {
            const response = await fetch('./api/obtener_todos_los_grupos.php');
            const data = await response.json();
            const grupos = data.flatMap(cat => cat.grupos || []);
            cargarOpciones(subgroupGroupSelect, grupos, 'Seleccione un grupo');
        } catch (error) {
            console.error('Error al cargar grupos:', error);
            subgroupGroupSelect.innerHTML = '<option value="">Error al cargar</option>';
        }
    }

    // Cargar la estructura de grupos y subgrupos
    async function cargarEstructura() {
        const container = document.getElementById('structureDisplay');
        container.innerHTML = `<div class="list-group-item text-muted text-center">Cargando estructura...</div>`;
        try {
            const response = await fetch('./api/obtener_todos_los_grupos.php');
            const data = await response.json();
            let html = '';
            if (data.length === 0) {
                html = `<div class="list-group-item text-muted text-center">No hay categorías, grupos o subgrupos creados.</div>`;
            } else {
                data.forEach(cat => {
                    html += `<a href="#" class="list-group-item list-group-item-action category"><i class="bi bi-folder me-2"></i>${cat.nombre}</a>`;
                    if (cat.grupos && cat.grupos.length > 0) {
                        cat.grupos.forEach(grupo => {
                            html += `<a href="#" class="list-group-item list-group-item-action group ms-3"><i class="bi bi-folder-fill me-2"></i>${grupo.nombre}</a>`;
                            if (grupo.subgrupos && grupo.subgrupos.length > 0) {
                                grupo.subgrupos.forEach(sub => {
                                    html += `<a href="#" class="list-group-item list-group-item-action subgroup ms-5"><i class="bi bi-collection-fill me-2"></i>${sub.nombre}</a>`;
                                });
                            }
                        });
                    }
                });
            }
            container.innerHTML = html;
        } catch (error) {
            console.error('Error al cargar la estructura:', error);
            container.innerHTML = `<div class="list-group-item text-danger text-center">Error al cargar la estructura.</div>`;
        }
    }

    // Cargar y mostrar el menú completo
    async function cargarMenu() {
        const container = document.getElementById('menuDisplay');
        container.innerHTML = `<div class="list-group-item text-muted text-center">Cargando menú...</div>`;
        try {
            // Esta API debe devolver la estructura completa con productos anidados
            const response = await fetch('./api/obtener_menu_completo.php'); 
            const data = await response.json();
            let html = '';
            
            if (data.length === 0) {
                html = `<div class="list-group-item text-muted text-center">Menú vacío. Agrega categorías y productos.</div>`;
            } else {
                data.forEach(cat => {
                    html += `<div class="mb-4">
                                <h3 class="text-primary mb-3">${cat.nombre}</h3>`;
                    if (cat.grupos && cat.grupos.length > 0) {
                        cat.grupos.forEach(grupo => {
                            html += `<div class="ms-4 mb-3">
                                        <h4 class="text-secondary">${grupo.nombre}</h4>`;
                            if (grupo.subgrupos && grupo.subgrupos.length > 0) {
                                grupo.subgrupos.forEach(sub => {
                                    html += `<div class="ms-4 mb-2">
                                                <h5 class="text-dark">${sub.nombre}</h5>
                                                <ul class="list-group list-group-flush">`;
                                    if (sub.productos && sub.productos.length > 0) {
                                        sub.productos.forEach(prod => {
                                            html += `<li class="list-group-item product d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong class="text-capitalize">${prod.nombre}</strong> <span class="badge bg-light text-secondary ms-2">${prod.codigo}</span>
                                                            <br><small class="text-muted">${prod.detalle || 'Sin detalles'}</small>
                                                        </div>
                                                        <span class="product-price">$${parseFloat(prod.precio).toFixed(2)}</span>
                                                     </li>`;
                                        });
                                    } else {
                                        html += `<li class="list-group-item text-muted">No hay productos en este subgrupo.</li>`;
                                    }
                                    html += `</ul></div>`;
                                });
                            }
                            if (grupo.productos && grupo.productos.length > 0) {
                                html += `<ul class="list-group list-group-flush">`;
                                grupo.productos.forEach(prod => {
                                    html += `<li class="list-group-item product d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong class="text-capitalize">${prod.nombre}</strong> <span class="badge bg-light text-secondary ms-2">${prod.codigo}</span>
                                                    <br><small class="text-muted">${prod.detalle || 'Sin detalles'}</small>
                                                </div>
                                                <span class="product-price">$${parseFloat(prod.precio).toFixed(2)}</span>
                                             </li>`;
                                });
                                html += `</ul>`;
                            }
                            html += `</div>`;
                        });
                    }
                    if (cat.productos && cat.productos.length > 0) {
                        html += `<ul class="list-group list-group-flush">`;
                        cat.productos.forEach(prod => {
                             html += `<li class="list-group-item product d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="text-capitalize">${prod.nombre}</strong> <span class="badge bg-light text-secondary ms-2">${prod.codigo}</span>
                                            <br><small class="text-muted">${prod.detalle || 'Sin detalles'}</small>
                                        </div>
                                        <span class="product-price">$${parseFloat(prod.precio).toFixed(2)}</span>
                                    </li>`;
                        });
                        html += `</ul>`;
                    }
                    html += `</div>`;
                });
            }
            container.innerHTML = html;
        } catch (error) {
            console.error('Error al cargar el menú:', error);
            container.innerHTML = `<div class="list-group-item text-danger text-center">Error al cargar el menú.</div>`;
        }
    }


    // Función para generar un código único incremental
    async function generarSiguienteCodigo(categoria, grupo, subgrupo, subSubgrupo) {
        const response = await fetch(`./api/generar_codigo.php?categoria=${categoria}&grupo=${grupo}&subgrupo=${subgrupo}&sub_subgrupo=${subSubgrupo}`);
        const data = await response.json();
        return data.codigo;
    }

    // --- Event Listeners y Lógica de Interfaz ---

    // Cargar dependencias al cambiar de categoría en el formulario de producto
    categoriaSelect.addEventListener('change', async () => {
        const categoriaId = categoriaSelect.value;
        grupoSelect.disabled = true;
        subgrupoSelect.disabled = true;
        sub_subgrupoSelect.disabled = true;
        codigoInput.value = '';

        if (categoriaId) {
            try {
                const response = await fetch(`./api/obtener_grupos.php?categoria=${encodeURIComponent(categoriaId)}`);
                const data = await response.json();
                cargarOpciones(grupoSelect, data, 'Seleccione un grupo (opcional)');
            } catch (error) {
                console.error('Error al cargar grupos:', error);
                grupoSelect.innerHTML = '<option value="">Error al cargar</option>';
            }
        }
    });

    // Cargar dependencias al cambiar de grupo en el formulario de producto
    grupoSelect.addEventListener('change', async () => {
        const categoriaId = categoriaSelect.value;
        const grupoId = grupoSelect.value;
        subgrupoSelect.disabled = true;
        sub_subgrupoSelect.disabled = true;
        codigoInput.value = '';

        if (grupoId) {
            try {
                const response = await fetch(`./api/obtener_subgrupos.php?categoria=${encodeURIComponent(categoriaId)}&grupo=${encodeURIComponent(grupoId)}`);
                const data = await response.json();
                cargarOpciones(subgrupoSelect, data, 'Seleccione un subgrupo (opcional)');
            } catch (error) {
                console.error('Error al cargar subgrupos:', error);
                subgrupoSelect.innerHTML = '<option value="">Error al cargar</option>';
            }
        }
    });

    // Cargar dependencias al cambiar de subgrupo en el formulario de producto
    subgrupoSelect.addEventListener('change', async () => {
        const categoriaId = categoriaSelect.value;
        const grupoId = grupoSelect.value;
        const subgrupoId = subgrupoSelect.value;
        sub_subgrupoSelect.disabled = true;
        codigoInput.value = '';

        if (subgrupoId) {
            try {
                const response = await fetch(`./api/obtener_subsubgrupos.php?categoria=${encodeURIComponent(categoriaId)}&grupo=${encodeURIComponent(grupoId)}&subgrupo=${encodeURIComponent(subgrupoId)}`);
                const data = await response.json();
                cargarOpciones(sub_subgrupoSelect, data, 'Seleccione un sub-subgrupo (opcional)');
            } catch (error) {
                console.error('Error al cargar sub-subgrupos:', error);
                sub_subgrupoSelect.innerHTML = '<option value="">Error al cargar</option>';
            }
        }
    });

    // Generar código al cambiar el último nivel de jerarquía
    sub_subgrupoSelect.addEventListener('change', async () => {
        const categoria = categoriaSelect.options[categoriaSelect.selectedIndex].text;
        const grupo = grupoSelect.options[grupoSelect.selectedIndex].text;
        const subgrupo = subgrupoSelect.options[subgrupoSelect.selectedIndex].text;
        const subSubgrupo = sub_subgrupoSelect.options[sub_subgrupoSelect.selectedIndex].text;
        codigoInput.value = await generarSiguienteCodigo(categoria, grupo, subgrupo, subSubgrupo);
    });

    // Envío del formulario de producto
    document.getElementById('formCrearProducto').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value;
        const precio = document.getElementById('precio').value;
        const stock = document.getElementById('stock').value;
        const categoria = categoriaSelect.value;
        const grupo = grupoSelect.value;
        const subgrupo = subgrupoSelect.value;
        const sub_subgrupo = sub_subgrupoSelect.value;
        const codigo = codigoInput.value;
        const detalle = document.getElementById('detalle').value;
        const mensajeDiv = document.getElementById('resultado-mensaje');
        mensajeDiv.innerHTML = '';

        if (!codigo) {
            mensajeDiv.innerHTML = '<div class="alert alert-warning">Por favor, complete los campos obligatorios para generar el código.</div>';
            return;
        }

        try {
            const response = await fetch('./api/crear_producto.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, precio, stock, categoria, grupo, subgrupo, sub_subgrupo, codigo, detalle })
            });
            const resultado = await response.json();

            if (resultado.success) {
                mensajeDiv.innerHTML = '<div class="alert alert-success">Producto creado correctamente.</div>';
                document.getElementById('formCrearProducto').reset();
                codigoInput.value = '';
                // Recargar todo
                cargarCategoriasGrupos();
                cargarGruposParaSubgrupos();
                cargarEstructura();
                cargarMenu();
            } else {
                mensajeDiv.innerHTML = `<div class="alert alert-danger">${resultado.message}</div>`;
            }
        } catch (error) {
            console.error('Error al crear el producto:', error);
            mensajeDiv.innerHTML = '<div class="alert alert-danger">Hubo un error de conexión. Por favor, intente de nuevo.</div>';
        }
    });

    // Envío de formulario de categoría
    categoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const categoryName = document.getElementById('categoryName').value;
        try {
            const response = await fetch('./api/crear_categoria.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: categoryName })
            });
            const resultado = await response.json();
            if (resultado.success) {
                alert('Categoría creada con éxito.');
                categoryForm.reset();
                cargarCategoriasGrupos();
                cargarEstructura();
            } else {
                alert('Error: ' + resultado.message);
            }
        } catch (error) {
            alert('Error de conexión.');
        }
    });

    // Envío de formulario de grupo
    groupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const categoriaId = groupCategorySelect.value;
        const groupName = document.getElementById('groupName').value;
        try {
            const response = await fetch('./api/crear_grupo.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categoria_id: categoriaId, nombre: groupName })
            });
            const resultado = await response.json();
            if (resultado.success) {
                alert('Grupo creado con éxito.');
                groupForm.reset();
                cargarGruposParaSubgrupos();
                cargarEstructura();
            } else {
                alert('Error: ' + resultado.message);
            }
        } catch (error) {
            alert('Error de conexión.');
        }
    });

    // Envío de formulario de subgrupo
    subgroupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const groupId = subgroupGroupSelect.value;
        const subgroupName = document.getElementById('subgroupName').value;
        try {
            const response = await fetch('./api/crear_subgrupo.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ grupo_id: groupId, nombre: subgroupName })
            });
            const resultado = await response.json();
            if (resultado.success) {
                alert('Subgrupo creado con éxito.');
                subgroupForm.reset();
                cargarEstructura();
            } else {
                alert('Error: ' + resultado.message);
            }
        } catch (error) {
            alert('Error de conexión.');
        }
    });

    // Cargar datos al cambiar de pestaña
    document.getElementById('gestionar-grupos-tab').addEventListener('shown.bs.tab', () => {
        cargarEstructura();
        cargarCategoriasGrupos();
        cargarGruposParaSubgrupos();
    });

    document.getElementById('crear-producto-tab').addEventListener('shown.bs.tab', () => {
        cargarCategoriasGrupos();
    });

    document.getElementById('gestionar-menu-tab').addEventListener('shown.bs.tab', () => {
        cargarMenu();
    });

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        cargarCategoriasGrupos();
        cargarEstructura();
        cargarMenu();
    });
</script>

</body>
</html>