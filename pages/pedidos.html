<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - DMENUNET</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .pedido-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .pedido-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .estado-badge {
            font-size: 0.8em;
            font-weight: bold;
            padding: 0.3em 0.8em;
            border-radius: 1rem;
            text-align: center;
        }
        .bg-preparacion { background-color: #fff3cd; color: #856404; }
        .bg-servido { background-color: #d4edda; color: #155724; }
        .bg-entregado { background-color: #cce5ff; color: #004085; }
        .bg-cancelado { background-color: #f8d7da; color: #721c24; }
        .list-group-item:hover {
            background-color: #f1f1f1;
        }
        .modal-body-scrollable {
            max-height: 50vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/index.html"><i class="bi bi-house me-2"></i>DMENUNET</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="inventario.html"><i class="bi bi-boxes"></i> Inventario</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="crear_producto.html"><i class="bi bi-plus-circle"></i> Crear Producto</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="mesas.html"><i class="bi bi-shop"></i> Mesas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="pedidos.html"><i class="bi bi-receipt"></i> Pedidos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="historial_ventas.html"><i class="bi bi-clock-history"></i> Historial de Ventas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ajustes.html"><i class="bi bi-gear"></i> Ajustes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="caja.html"><i class="bi bi-cash-stack"></i> Caja</a>
                </li>
            </ul>
            <a href="/Dmenunet/api/logout.php" class="btn btn-outline-light">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
            </a>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Pedidos</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoPedido">
            <i class="bi bi-plus me-1"></i> Nuevo Pedido
        </button>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Buscar por ID o cliente...">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn"><i class="bi bi-search"></i></button>
            </div>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="estadoFilter">
                <option value="todos">Todos los estados</option>
                <option value="en_preparacion">En preparación</option>
                <option value="servido">Servido</option>
                <option value="entregado">Entregado</option>
                <option value="cancelado">Cancelado</option>
            </select>
        </div>
    </div>
    
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4" id="pedidos-container">
        <div id="loading-message" class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando pedidos...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoPedido" tabindex="-1" aria-labelledby="modalNuevoPedidoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevoPedidoLabel">Nuevo Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoPedido">
                    <h6 class="border-bottom pb-2 mb-3">Datos del Pedido</h6>
                    <div class="mb-3">
                        <label for="tipoPedido" class="form-label">Tipo de Pedido</label>
                        <select class="form-select" id="tipoPedido" required>
                            <option value="en_restaurante" selected>En restaurante (Mesa)</option>
                            <option value="para_llevar">Para llevar</option>
                            <option value="domicilio">Domicilio</option>
                        </select>
                    </div>
                    <div id="seccionMesa" class="mb-3">
                        <label for="mesaSelect" class="form-label">Seleccionar Mesa Disponible</label>
                        <select class="form-select" id="mesaSelect" required>
                            </select>
                    </div>
                    <div id="seccionCliente" class="mb-3 d-none">
                        <label for="clienteInput" class="form-label">Nombre del Cliente</label>
                        <input type="text" class="form-control" id="clienteInput" placeholder="Ej: Juan Pérez">
                    </div>
                    
                    <h6 class="border-bottom pb-2 mt-4 mb-3">Productos</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="buscarProductoInput" placeholder="Buscar producto...">
                        <button class="btn btn-primary" type="button" id="buscarProductoBtn"><i class="bi bi-search"></i></button>
                    </div>
                    <div class="list-group modal-body-scrollable" id="productosResultados">
                        </div>
                    <hr>
                    <div id="productosSeleccionados" class="mb-3">
                        <p class="text-muted">No hay productos en el pedido.</p>
                        <ul class="list-group" id="pedido-list"></ul>
                    </div>

                    <div class="d-flex justify-content-end align-items-center mt-4">
                        <h4 class="me-3 mb-0">Total: <span id="totalPedido">$0</span></h4>
                        <button type="submit" class="btn btn-primary btn-lg">Crear Pedido</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarPedido" tabindex="-1" aria-labelledby="modalEditarPedidoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarPedidoLabel">Detalles del Pedido <span id="pedidoIdDisplay"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalEditarBody">
                </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-danger" id="cancelarOrdenBtn">
                    <i class="bi bi-trash"></i> Cancelar Orden
                </button>
                <button type="button" class="btn btn-success" id="cerrarCuentaBtn">
                    <i class="bi bi-cash-stack"></i> Cerrar Cuenta
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCerrarCuenta" tabindex="-1" aria-labelledby="modalCerrarCuentaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCerrarCuentaLabel">Cerrar Cuenta y Pagar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="ticket-preview">
                    </div>
                <div class="mt-4">
                    <h6>Medio de Pago</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="medioPago" id="pagoEfectivo" value="efectivo" checked>
                        <label class="form-check-label" for="pagoEfectivo">Efectivo</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="medioPago" id="pagoDebito" value="tarjeta_debito">
                        <label class="form-check-label" for="pagoDebito">Tarjeta Débito</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="medioPago" id="pagoCredito" value="tarjeta_credito">
                        <label class="form-check-label" for="pagoCredito">Tarjeta Crédito</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="medioPago" id="pagoBono" value="bono">
                        <label class="form-check-label" for="pagoBono">Bono</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmarPagoBtn">Confirmar Pago e Imprimir</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_PEDIDOS_URL = './api/pedidos/';
    const API_MESAS_URL = './api/mesas.php';
    const API_PRODUCTOS_URL = './api/productos.php';
    
    const pedidosContainer = document.getElementById('pedidos-container');
    const modalNuevoPedido = new bootstrap.Modal(document.getElementById('modalNuevoPedido'));
    const modalEditarPedido = new bootstrap.Modal(document.getElementById('modalEditarPedido'));
    const modalCerrarCuenta = new bootstrap.Modal(document.getElementById('modalCerrarCuenta'));
    const formNuevoPedido = document.getElementById('formNuevoPedido');
    const pedidoListModalNuevo = document.getElementById('pedido-list');
    const totalPedidoSpan = document.getElementById('totalPedido');
    let pedidoActual = [];
    let productosDisponibles = [];
    let todosLosPedidos = [];
    let pedidoParaCerrar = null;

    async function cargarPedidos() {
        pedidosContainer.innerHTML = `<div id="loading-message" class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando pedidos...</p>
        </div>`;

        try {
            const response = await fetch(`${API_PEDIDOS_URL}obtener.php`);
            todosLosPedidos = await response.json();
            mostrarPedidos(todosLosPedidos);
        } catch (error) {
            console.error('Error al cargar pedidos:', error);
            pedidosContainer.innerHTML = `<div class="col-12 text-center text-danger">Error al cargar los pedidos.</div>`;
        }
    }

    function mostrarPedidos(pedidos) {
        pedidosContainer.innerHTML = '';
        if (pedidos.length === 0) {
            pedidosContainer.innerHTML = `<div class="col-12 text-center text-muted">No hay pedidos activos.</div>`;
            return;
        }
        
        pedidos.forEach(pedido => {
            const card = document.createElement('div');
            card.className = 'col';
            let estadoClass = '';
            switch(pedido.estado) {
                case 'en_preparacion': estadoClass = 'bg-preparacion'; break;
                case 'servido': estadoClass = 'bg-servido'; break;
                case 'entregado': estadoClass = 'bg-entregado'; break;
                case 'cancelado': estadoClass = 'bg-cancelado'; break;
                default: estadoClass = 'bg-light';
            }

            const tipo = pedido.mesa_id ? 'En restaurante' : 'Para llevar / Domicilio';

            card.innerHTML = `
                <div class="card pedido-card h-100 shadow-sm" data-id="${pedido.id}">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">ORD-${pedido.id.padStart(3, '0')}</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary ver-btn me-1" data-id="${pedido.id}"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-outline-primary editar-btn" data-id="${pedido.id}"><i class="bi bi-pencil"></i></button>
                            </div>
                        </div>
                        <p class="card-text mb-1">Mesa ${pedido.mesa_nombre || 'N/A'} • ${tipo}</p>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-person me-2"></i>
                            <small>${pedido.cliente_nombre || 'N/A'}</small>
                        </div>
                        <h4 class="text-primary mb-2">$${parseFloat(pedido.total).toFixed(2)}</h4>
                        <span class="estado-badge ${estadoClass} mt-auto">${pedido.estado.replace(/_/g, ' ').toUpperCase()}</span>
                    </div>
                </div>
            `;
            pedidosContainer.appendChild(card);
        });
    }

    // Funcionalidad de filtrado y búsqueda
    document.getElementById('estadoFilter').addEventListener('change', filtrarPedidos);
    document.getElementById('searchInput').addEventListener('input', filtrarPedidos);
    document.getElementById('searchBtn').addEventListener('click', filtrarPedidos);

    function filtrarPedidos() {
        const estadoSeleccionado = document.getElementById('estadoFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        const pedidosFiltrados = todosLosPedidos.filter(pedido => {
            const matchEstado = estadoSeleccionado === 'todos' || pedido.estado === estadoSeleccionado;
            const matchSearch = pedido.id.toString().includes(searchTerm) || (pedido.cliente_nombre && pedido.cliente_nombre.toLowerCase().includes(searchTerm));
            return matchEstado && matchSearch;
        });

        mostrarPedidos(pedidosFiltrados);
    }

    // Funcionalidad para el modal de "Nuevo Pedido"
    document.getElementById('tipoPedido').addEventListener('change', (e) => {
        const tipo = e.target.value;
        document.getElementById('seccionMesa').classList.toggle('d-none', tipo !== 'en_restaurante');
        document.getElementById('seccionCliente').classList.toggle('d-none', tipo === 'en_restaurante');
    });

    async function cargarMesasDisponibles() {
        try {
            const response = await fetch(`${API_MESAS_URL}?estado=disponible`);
            const mesas = await response.json();
            const select = document.getElementById('mesaSelect');
            select.innerHTML = '<option value="" disabled selected>Selecciona una mesa</option>';
            if (mesas.length > 0) {
                mesas.forEach(mesa => {
                    const option = document.createElement('option');
                    option.value = mesa.id;
                    option.textContent = `Mesa ${mesa.nombre} (${mesa.capacidad} personas)`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="" disabled selected>No hay mesas disponibles</option>';
            }
        } catch (error) {
            console.error('Error al cargar mesas disponibles:', error);
        }
    }

    async function cargarProductos() {
        try {
            const response = await fetch(API_PRODUCTOS_URL);
            productosDisponibles = await response.json();
        } catch (error) {
            console.error('Error al cargar productos:', error);
        }
    }

    // Buscar productos
    document.getElementById('buscarProductoBtn').addEventListener('click', () => {
        const query = document.getElementById('buscarProductoInput').value.toLowerCase();
        const resultadosDiv = document.getElementById('productosResultados');
        resultadosDiv.innerHTML = '';
        const resultados = productosDisponibles.filter(p => p.nombre.toLowerCase().includes(query) || p.codigo.toLowerCase().includes(query));

        if (resultados.length > 0) {
            resultados.forEach(producto => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>${producto.nombre} <small class="text-muted">($${parseFloat(producto.precio).toFixed(2)})</small></div>
                    <button type="button" class="btn btn-sm btn-outline-primary agregar-producto-btn" data-id="${producto.id}" data-nombre="${producto.nombre}" data-precio="${producto.precio}">
                        Agregar
                    </button>
                `;
                resultadosDiv.appendChild(item);
            });
        } else {
            resultadosDiv.innerHTML = `<p class="text-muted p-2">No se encontraron productos.</p>`;
        }
    });

    // Agregar producto al pedido en el modal de nuevo pedido
    document.getElementById('productosResultados').addEventListener('click', (e) => {
        const addButton = e.target.closest('.agregar-producto-btn');
        if (!addButton) return;

        const id = addButton.dataset.id;
        const nombre = addButton.dataset.nombre;
        const precio = parseFloat(addButton.dataset.precio);

        const itemExistente = pedidoActual.find(item => item.id == id);
        if (itemExistente) {
            itemExistente.cantidad++;
        } else {
            pedidoActual.push({ id, nombre, precio, cantidad: 1 });
        }

        actualizarPedidoEnModalNuevo();
    });

    function actualizarPedidoEnModalNuevo() {
        pedidoListModalNuevo.innerHTML = '';
        let total = 0;
        if (pedidoActual.length === 0) {
            document.getElementById('productosSeleccionados').querySelector('p').classList.remove('d-none');
            pedidoListModalNuevo.classList.add('d-none');
        } else {
            document.getElementById('productosSeleccionados').querySelector('p').classList.add('d-none');
            pedidoListModalNuevo.classList.remove('d-none');
        }

        pedidoActual.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>${item.nombre} x <span class="fw-bold">${item.cantidad}</span></div>
                <div>
                    <span class="me-3">$${(item.precio * item.cantidad).toFixed(2)}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger eliminar-producto-btn" data-id="${item.id}">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            `;
            pedidoListModalNuevo.appendChild(li);
            total += item.precio * item.cantidad;
        });
        totalPedidoSpan.textContent = `$${total.toFixed(2)}`;
    }

    // Eliminar producto del pedido en el modal de nuevo pedido
    pedidoListModalNuevo.addEventListener('click', (e) => {
        const deleteButton = e.target.closest('.eliminar-producto-btn');
        if (!deleteButton) return;

        const id = deleteButton.dataset.id;
        const itemExistente = pedidoActual.find(item => item.id == id);
        if (itemExistente.cantidad > 1) {
            itemExistente.cantidad--;
        } else {
            pedidoActual = pedidoActual.filter(item => item.id != id);
        }
        actualizarPedidoEnModalNuevo();
    });

    // Crear nuevo pedido
    formNuevoPedido.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (pedidoActual.length === 0) {
            alert('El pedido está vacío. Por favor, agrega productos.');
            return;
        }

        const tipoPedido = document.getElementById('tipoPedido').value;
        let datos = {
            tipo: tipoPedido,
            productos: pedidoActual,
            total: parseFloat(totalPedidoSpan.textContent.replace('$', ''))
        };

        if (tipoPedido === 'en_restaurante') {
            const mesaSelect = document.getElementById('mesaSelect');
            const mesaId = mesaSelect.value;
            if (!mesaId) {
                alert('Por favor, selecciona una mesa.');
                return;
            }
            datos.mesa_id = mesaId;
        } else {
            datos.cliente = document.getElementById('clienteInput').value;
        }

        try {
            const response = await fetch(`${API_PEDIDOS_URL}crear.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            const result = await response.json();
            if (result.success) {
                alert('Pedido creado con éxito!');
                modalNuevoPedido.hide();
                pedidoActual = [];
                formNuevoPedido.reset();
                actualizarPedidoEnModalNuevo();
                cargarPedidos();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            console.error('Error al crear pedido:', error);
            alert('Hubo un problema al crear el pedido.');
        }
    });

    // Manejar el evento de los botones "Ver" y "Editar"
    pedidosContainer.addEventListener('click', async (e) => {
        const button = e.target.closest('.ver-btn') || e.target.closest('.editar-btn');
        if (!button) return;

        const pedidoId = button.dataset.id;
        pedidoParaCerrar = pedidoId;
        
        try {
            const response = await fetch(`${API_PEDIDOS_URL}obtener.php?id=${pedidoId}`);
            const pedido = await response.json();
            
            if (pedido.error) {
                alert(`Error: ${pedido.error}`);
                return;
            }
            
            const modalBody = document.getElementById('modalEditarBody');
            document.getElementById('pedidoIdDisplay').textContent = `(ID: ${pedido.id.padStart(3, '0')})`;
            
            let productosHtml = '';
            pedido.productos.forEach(item => {
                productosHtml += `
                    <li class="list-group-item">
                        ${item.nombre} - Cantidad: ${item.cantidad} - Precio: $${parseFloat(item.precio).toFixed(2)}
                    </li>
                `;
            });

            modalBody.innerHTML = `
                <h6>Detalles del Pedido</h6>
                <p><strong>Mesa:</strong> ${pedido.mesa_nombre || 'N/A'}</p>
                <p><strong>Estado:</strong> ${pedido.estado.replace(/_/g, ' ').toUpperCase()}</p>
                <p><strong>Fecha:</strong> ${new Date(pedido.fecha_creacion).toLocaleString()}</p>
                <h6>Productos del Pedido</h6>
                <ul class="list-group">${productosHtml}</ul>
                <h5 class="mt-3">Total: $${parseFloat(pedido.total).toFixed(2)}</h5>
            `;
            modalEditarPedido.show();
        } catch (error) {
            console.error('Error al cargar detalles del pedido:', error);
            alert('Hubo un problema al cargar los detalles del pedido.');
        }
    });

    // Botón para cerrar la cuenta (del modal de editar pedido)
    document.getElementById('cerrarCuentaBtn').addEventListener('click', () => {
        modalEditarPedido.hide();
        modalCerrarCuenta.show();
        generarTicket();
    });

    async function generarTicket() {
        if (!pedidoParaCerrar) return;

        try {
            const response = await fetch(`${API_PEDIDOS_URL}obtener.php?id=${pedidoParaCerrar}`);
            const pedido = await response.json();
            const ticketPreview = document.getElementById('ticket-preview');
            
            let productosTicket = '';
            let total = 0;
            pedido.productos.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                productosTicket += `<p>${item.nombre} x${item.cantidad} - $${subtotal.toFixed(2)}</p>`;
                total += subtotal;
            });

            ticketPreview.innerHTML = `
                <div style="font-family: monospace; font-size: 12px;">
                    <h5 style="text-align: center;">DMENUNET RESTAURANT</h5>
                    <p style="text-align: center;">--- Ticket de Venta ---</p>
                    <p>Pedido #${pedido.id}</p>
                    <p>Mesa: ${pedido.mesa_nombre || 'N/A'}</p>
                    <p>Fecha: ${new Date().toLocaleString()}</p>
                    <p>-------------------------</p>
                    ${productosTicket}
                    <p>-------------------------</p>
                    <p>Total: $${total.toFixed(2)}</p>
                    <p style="text-align: center;">¡Gracias por su visita!</p>
                </div>
            `;
        } catch (error) {
            console.error('Error al generar el ticket:', error);
            alert('No se pudo generar el ticket.');
        }
    }

    document.getElementById('confirmarPagoBtn').addEventListener('click', async () => {
        const medioPago = document.querySelector('input[name="medioPago"]:checked').value;
        try {
            const response = await fetch(`${API_PEDIDOS_URL}cerrar.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: pedidoParaCerrar, medio_pago: medioPago })
            });
            const result = await response.json();
            if (result.success) {
                alert('Cuenta cerrada y venta registrada. El ticket se ha enviado a la impresora.');
                modalCerrarCuenta.hide();
                cargarPedidos();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            console.error('Error al cerrar la cuenta:', error);
            alert('Hubo un problema al procesar el pago.');
        }
    });

    document.getElementById('cancelarOrdenBtn').addEventListener('click', async () => {
        if (confirm('¿Estás seguro de que quieres cancelar esta orden? Esta acción no se puede deshacer.')) {
            try {
                const response = await fetch(`${API_PEDIDOS_URL}cancelar.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: pedidoParaCerrar })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Orden cancelada con éxito.');
                    modalEditarPedido.hide();
                    cargarPedidos();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error al cancelar la orden:', error);
                alert('Hubo un problema al cancelar la orden.');
            }
        }
    });

    // Inicializar la página
    document.addEventListener('DOMContentLoaded', () => {
        cargarPedidos();
        cargarMesasDisponibles();
        cargarProductos();
    });
</script>
</body>
</html>