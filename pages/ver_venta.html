<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Venta - DMENUNET</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            .ticket-print-area, .ticket-print-area * {
                visibility: visible;
            }
            .ticket-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            /* Ocultar elementos que no deben imprimirse */
            .navbar, .btn, #error-message, #loading-message {
                display: none;
            }
            /* Estilos básicos para el ticket */
            .ticket {
                font-family: 'Courier New', Courier, monospace;
                font-size: 12px;
                padding: 10mm;
            }
            .ticket-header, .ticket-footer {
                text-align: center;
                margin-bottom: 10px;
            }
            .ticket-products {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 10px;
            }
            .ticket-products th, .ticket-products td {
                padding: 2px 0;
            }
            .ticket-total {
                text-align: right;
                font-weight: bold;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/index_prueba.html"><i class="bi bi-house me-2"></i>DMENUNET</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="inventario.html"><i class="bi bi-boxes"></i> Inventario</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="crear_producto.html"><i class="bi bi-plus-circle"></i> Crear Producto</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="mesas.html"><i class="bi bi-shop"></i> Mesas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="pedidos.html"><i class="bi bi-receipt"></i> Pedidos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="historial_ventas.html"><i class="bi bi-clock-history"></i> Historial de Ventas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ajustes.html"><i class="bi bi-gear"></i> Ajustes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="caja.html"><i class="bi bi-cash-stack"></i> Caja</a>
                </li>
            </ul>
            <a href="/Dmenunet/api/logout.php" class="btn btn-outline-light">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
            </a>
        </div>
    </div>
</nav>


    <div class="container mt-5 ticket-print-area">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-3">Venta #<span id="venta-id"></span></h1>
            <p class="mb-0">**Fecha:** <span id="venta-fecha"></span></p>
        </div>

        <div class="card p-4 mt-3">
            <p>**Mesa:** <span id="venta-mesa"></span></p>
            <p>**Estado:** <span id="venta-estado"></span></p>
        </div>

        <h3 class="mt-5 mb-3">Productos Vendidos</h3>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Producto</th>
                        <th scope="col">Cantidad</th>
                        <th scope="col">Precio Unitario</th>
                        <th scope="col">Total</th>
                    </tr>
                </thead>
                <tbody id="productos-body">
                    </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-end mt-4">
            <h4 class="fw-bold">Total de la Venta: $<span id="venta-total">0.00</span></h4>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5">
            <button class="btn btn-danger" id="anular-btn" style="display: none;"><i class="bi bi-x-circle me-2"></i>Anular Venta</button>
            <button class="btn btn-info text-white" id="mover-btn" style="display: none;"><i class="bi bi-arrow-left-right me-2"></i>Mover de Mesa</button>
            <button class="btn btn-secondary" id="imprimir-btn" style="display: none;"><i class="bi bi-printer me-2"></i>Imprimir Ticket</button>
            <button class="btn btn-success" id="finalizar-btn" style="display: none;"><i class="bi bi-check-circle me-2"></i>Finalizar y Pagar</button>
        </div>
        
        <p id="loading-message" class="text-center mt-4">Cargando detalles...</p>
        <p id="error-message" class="text-danger text-center mt-4 d-none"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const ventaId = params.get('id');

            const ventaIdSpan = document.getElementById('venta-id');
            const ventaMesaSpan = document.getElementById('venta-mesa');
            const ventaFechaSpan = document.getElementById('venta-fecha');
            const ventaEstadoSpan = document.getElementById('venta-estado');
            const ventaTotalSpan = document.getElementById('venta-total');
            const productosBody = document.getElementById('productos-body');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const finalizarBtn = document.getElementById('finalizar-btn');
            const imprimirBtn = document.getElementById('imprimir-btn');
            const anularBtn = document.getElementById('anular-btn');
            const moverBtn = document.getElementById('mover-btn'); // Nuevo botón

            if (!ventaId) {
                errorMessage.textContent = 'ID de venta no proporcionado.';
                errorMessage.classList.remove('d-none');
                loadingMessage.classList.add('d-none');
                return;
            }

            ventaIdSpan.textContent = ventaId;
            let ventaGlobal = null;

            async function cargarDetallesVenta() {
                try {
                    loadingMessage.classList.remove('d-none');
                    errorMessage.classList.add('d-none');

                    const response = await fetch(`./api/obtener_detalle_venta.php?id=${ventaId}`);
                    
                    if (!response.ok) {
                        throw new Error('No se pudo encontrar la venta.');
                    }
                    
                    const venta = await response.json();

                    if (!venta) {
                        throw new Error('Venta no encontrada.');
                    }
                    
                    ventaGlobal = venta;

                    // Rellenar los datos de la venta
                    ventaMesaSpan.textContent = venta.mesa_id;
                    ventaFechaSpan.textContent = venta.fecha;
                    const estadoTexto = venta.estado.charAt(0).toUpperCase() + venta.estado.slice(1);
                    ventaEstadoSpan.textContent = estadoTexto;
                    let totalVenta = 0;

                    // Llenar la tabla de productos
                    productosBody.innerHTML = '';
                    if (venta.insumos && venta.insumos.length > 0) {
                        venta.insumos.forEach(item => {
                            const totalItem = parseFloat(item.precio) * parseInt(item.cantidad);
                            totalVenta += totalItem;
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.nombre}</td>
                                <td>${item.cantidad}</td>
                                <td>$${parseFloat(item.precio).toFixed(2)}</td>
                                <td>$${totalItem.toFixed(2)}</td>
                            `;
                            productosBody.appendChild(row);
                        });
                    } else {
                        productosBody.innerHTML = '<tr><td colspan="4" class="text-center">No hay productos registrados para esta venta.</td></tr>';
                    }

                    ventaTotalSpan.textContent = totalVenta.toFixed(2);
                    
                    // Mostrar los botones solo si la venta está activa
                    if (venta.estado === 'activa') {
                        finalizarBtn.style.display = 'inline-block';
                        anularBtn.style.display = 'inline-block';
                        moverBtn.style.display = 'inline-block';
                        imprimirBtn.style.display = 'inline-block';
                    } else {
                         imprimirBtn.style.display = 'inline-block';
                    }

                } catch (error) {
                    errorMessage.textContent = `Hubo un problema: ${error.message}`;
                    errorMessage.classList.remove('d-none');
                    console.error('Error al cargar detalles de venta:', error);
                } finally {
                    loadingMessage.classList.add('d-none');
                }
            }

            // =========================================================================
            // Lógica para finalizar la venta
            // =========================================================================
            finalizarBtn.addEventListener('click', async () => {
                if (ventaGlobal) {
                    try {
                        const response = await fetch('./api/finalizar_venta.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ventaId: ventaGlobal.id,
                                mesaId: ventaGlobal.mesa_id
                            })
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert('Venta finalizada y mesa liberada con éxito.');
                            window.location.href = 'historial_ventas.html';
                        } else {
                            throw new Error(result.message || 'Error desconocido al finalizar la venta.');
                        }

                    } catch (error) {
                        alert(`Error: ${error.message}`);
                        console.error('Error al finalizar la venta:', error);
                    }
                }
            });
            
            // =========================================================================
            // Lógica para anular la venta
            // =========================================================================
            anularBtn.addEventListener('click', async () => {
                if (ventaGlobal) {
                    if (confirm('¿Estás seguro de que quieres anular esta venta? Esta acción no se puede deshacer y devolverá los productos al inventario.')) {
                        try {
                            const response = await fetch('./api/anular_venta.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ventaId: ventaGlobal.id })
                            });

                            const result = await response.json();

                            if (response.ok && result.success) {
                                alert('Venta anulada con éxito. El inventario ha sido actualizado.');
                                window.location.href = 'historial_ventas.html';
                            } else {
                                throw new Error(result.message || 'Error desconocido al anular la venta.');
                            }
                        } catch (error) {
                            alert(`Error: ${error.message}`);
                            console.error('Error al anular la venta:', error);
                        }
                    }
                }
            });
            
            // =========================================================================
            // Lógica para mover la venta de mesa (NUEVA)
            // =========================================================================
            moverBtn.addEventListener('click', async () => {
                if (ventaGlobal) {
                    const nuevaMesaId = prompt('Ingrese el número de la nueva mesa:');
                    if (nuevaMesaId === null) {
                        return; // El usuario canceló
                    }

                    const idNumerico = parseInt(nuevaMesaId);
                    if (isNaN(idNumerico) || idNumerico <= 0) {
                        alert('Por favor, ingrese un número de mesa válido.');
                        return;
                    }
                    
                    if (idNumerico === ventaGlobal.mesa_id) {
                         alert('La mesa ingresada es la misma que la actual. No se realizarán cambios.');
                        return;
                    }

                    try {
                        const response = await fetch('./api/mover_mesa.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                ventaId: ventaGlobal.id, 
                                nuevaMesaId: idNumerico 
                            })
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert('Venta movida de mesa con éxito.');
                            cargarDetallesVenta(); // Recargar los detalles para mostrar el cambio
                        } else {
                            throw new Error(result.message || 'Error desconocido al mover la mesa.');
                        }
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                        console.error('Error al mover la venta:', error);
                    }
                }
            });

            // =========================================================================
            // Lógica para imprimir el ticket
            // =========================================================================
            imprimirBtn.addEventListener('click', () => {
                window.print();
            });

            cargarDetallesVenta();
        });
    </script>
</body>
</html>